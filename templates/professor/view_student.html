{% extends "base.html" %}

{% block title %}{{ student.first_name }} {{ student.last_name }} - Détails{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-2 sidebar d-none d-lg-block">
            <nav class="nav flex-column">
                <a class="nav-link" href="{{ url_for('professor.dashboard') }}">
                    <i class="fas fa-tachometer-alt"></i>Tableau de bord
                </a>
                <a class="nav-link" href="{{ url_for('professor.my_absences') }}">
                    <i class="fas fa-calendar-times"></i>Mes absences
                </a>
                <a class="nav-link" href="{{ url_for('professor.my_modules') }}">
                    <i class="fas fa-book"></i>Mes modules
                </a>
                <a class="nav-link active" href="{{ url_for('professor.my_classes') }}">
                    <i class="fas fa-users"></i>Mes classes
                </a>
                <a class="nav-link" href="{{ url_for('main.profile') }}">
                    <i class="fas fa-user"></i>Mon profil
                </a>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="col-lg-10">
            <div class="page-header d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-user-graduate me-2"></i>{{ student.first_name }} {{ student.last_name }}</h1>
                    <p class="text-muted">{{ student.student_id or 'N/A' }} - {{ student.classe.name if student.classe else 'Aucune classe' }}</p>
                </div>
                <a href="javascript:history.back()" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Retour
                </a>
            </div>
            
            <!-- Student Info -->
            <div class="row g-4 mb-4">
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header bg-white py-3">
                            <h5 class="mb-0"><i class="fas fa-user me-2"></i>Informations</h5>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-3">
                                {% if student.photo %}
                                    <img src="{{ url_for('static', filename='image/' + student.photo) }}" class="rounded-circle" width="100" height="100" alt="Photo">
                                {% else %}
                                    <div class="avatar-placeholder mx-auto" style="width: 100px; height: 100px; font-size: 2.5rem;">
                                        {{ student.first_name[0] | upper }}
                                    </div>
                                {% endif %}
                            </div>
                            <table class="table table-borderless">
                                <tr>
                                    <td class="text-muted">Email</td>
                                    <td><strong>{{ student.user.email }}</strong></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Téléphone</td>
                                    <td><strong>{{ student.phone or 'N/A' }}</strong></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Semestre</td>
                                    <td><strong>{{ student.current_semester }}</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Absence Stats by Module -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-white py-3">
                            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Absences par module</h5>
                        </div>
                        <div class="card-body">
                            {% for stat in absence_stats %}
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">{{ stat.module.name }}</h6>
                                    <span class="badge {% if stat.status == 'exceeded' %}bg-danger{% elif stat.status == 'warning' %}bg-warning{% else %}bg-success{% endif %}">
                                        {% if stat.status == 'exceeded' %}Seuil dépassé
                                        {% elif stat.status == 'warning' %}Attention
                                        {% else %}OK
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <small class="text-muted">{{ stat.hours }}h / {{ stat.module.absence_threshold }}h</small>
                                    <small class="text-muted">{{ stat.rate|round(1) }}%</small>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar {% if stat.rate >= 100 %}bg-danger{% elif stat.rate >= 50 %}bg-warning{% else %}bg-success{% endif %}" 
                                         style="width: {{ [stat.rate, 100] | min }}%"></div>
                                </div>
                            </div>
                            {% else %}
                            <p class="text-muted text-center mb-0">Aucune donnée disponible</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Detailed Absences -->
            {% for stat in absence_stats %}
            {% if stat.absences %}
            <div class="card mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0"><i class="fas fa-calendar-times me-2"></i>{{ stat.module.name }} - Détail des absences</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Heures</th>
                                    <th>Motif</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for absence in stat.absences %}
                                <tr>
                                    <td>{{ absence.date.strftime('%d/%m/%Y') }}</td>
                                    <td>{{ absence.hours }}h</td>
                                    <td>{{ absence.reason or '-' }}</td>
                                    <td>
                                        {% if absence.is_justified %}
                                            <span class="badge bg-success">Justifiée</span>
                                        {% else %}
                                            <span class="badge bg-danger">Non justifiée</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
